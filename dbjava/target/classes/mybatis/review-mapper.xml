<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC 
	"-//mybatis.org//DTD Mapper 3.0//EN" 
	"https://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.javabang.repository.ReviewDAO">
	<select id="reviewSelectAll" parameterType="int" resultType="review">
		select r.*, m.userNick, m.profile
			from review r
			join member m
				on r.member = m.idx
			where rent = #{idx} 
			order by r.idx asc
	</select>
	
	<select id="reviewFileSelectAll" parameterType="int" resultType="string">
		select filePath from review_img
			where review = #{review}
	</select>
	
	<insert id="insertReview" parameterType="review">
		insert into review (member, rent, content, point) values (${member}, ${rent}, #{content}, ${point})
	</insert>
	
	<insert id="fileInsert" parameterType="hashmap">			
			insert into review_img(review, filePath)
			values(${review}, #{filePath})
	</insert>
	
	<select id="selectIdx" resultType="int">
		select max(idx) from review
	</select>
	
	<delete id="deleteReview" parameterType="hashmap">
		delete from review where review.idx = ${reviewIdx} and review.member = ${memberIdx}
	</delete>
	
	<select id="selectAllMyReview" parameterType="int" resultType="review">
	    select r.*, (select listagg(filePath,',') 
	    				from review_img  i 
	    				where r.idx = i.review) as filePath
	         from review r
             where r.member = #{int}
             order by r.idx asc

	</select>
	
	<select id="selectAllMyReviewSearch" parameterType="hashmap" resultType="review">
		select r.*, (select listagg(filePath,',') 
		                from review_img  i 
		                where r.idx = i.review) as filePath
		     from review r
		     where r.member = ${idx}
		     and r.content like '%${search}%'
		     order by r.idx asc
	</select>
</mapper>